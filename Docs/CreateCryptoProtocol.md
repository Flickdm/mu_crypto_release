# CreateCryptoProtocol.py

A Python script that automatically generates UEFI protocol headers and library implementations from a crypto function library header file.

## Overview

This script transforms a header file containing crypto function declarations into:
1. **Protocol Header** - A UEFI protocol structure (`OneCryptoProtocol.h`)
2. **Library Headers** - Individual library headers for different crypto groups (e.g., `TlsLib.h`, `HmacLib.h`, `OneCryptoLib.h`)
3. **Library Implementation** - Protocol-based library implementation source files

## Purpose

The generated code enables a protocol-based architecture where:
- Crypto functionality is exposed through a UEFI protocol
- Libraries can call crypto functions through the protocol interface
- Functions are organized by logical groups (TLS, HMAC, etc.)
- Version information is automatically included

## Usage

### Basic Command

```bash
python CreateCryptoProtocol.py <header_file> [options]
```

### Options

| Option | Description | Default |
|--------|-------------|---------|
| `-p, --generate-protocol` | Generate the protocol header file | False |
| `--output-protocol <path>` | Specify output path for protocol header | `../../Include/Protocol/OneCryptoProtocol.h` |
| `-l, --generate-library` | Generate library header and source files | False |
| `-d, --debug` | Enable debug logging | False |

### Example Usage

From the repository root directory:

```bash
# Generate both protocol and library files from OneCryptoLibrary.h
python OneCryptoPkg/OneCryptoBin/Scripts/CreateCryptoProtocol.py \
    OpensslPkg/Include/Private/OneCryptoLibrary.h -p -l

# Generate only the protocol header
python OneCryptoPkg/OneCryptoBin/Scripts/CreateCryptoProtocol.py \
    OpensslPkg/Include/Private/OneCryptoLibrary.h -p

# Generate with custom output location
python OneCryptoPkg/OneCryptoBin/Scripts/CreateCryptoProtocol.py \
    OpensslPkg/Include/Private/OneCryptoLibrary.h -p \
    --output-protocol custom/path/OneCryptoProtocol.h
```

## Input Requirements

The input header file must contain function declarations with specific Doxygen-style annotations:

### Required Function Annotations

Each function must include:
- `@since X.Y.Z` - Version when the function was introduced
- `@ingroup GroupName` - Logical grouping (e.g., Tls, Hmac, OneCrypto)

### Example Input Format

```c
/**
  Creates a new HMAC context.

  @return  Pointer to the new HMAC context.

  @since 1.0.0
  @ingroup HMAC
**/
VOID *
EFIAPI
HmacSha256New (
  VOID
  );
```

### Version Definition

The header must also define version macros:

```c
#define VERSION_MAJOR     1ULL
#define VERSION_MINOR     0ULL
#define VERSION_REVISION  0ULL
```

## Generated Outputs

### 1. Protocol Header (`OneCryptoProtocol.h`)

Located in: `OneCryptoPkg/Include/Protocol/OneCryptoProtocol.h`

Contains:
- Function pointer typedefs for all crypto functions
- `ONE_CRYPTO_PROTOCOL` structure with function pointers
- Version information fields (Major, Minor, Revision)
- Protocol GUID declarations

Example structure:

```c
typedef struct _ONE_CRYPTO_PROTOCOL {
  UINT64                  Major;
  UINT64                  Minor;
  UINT64                  Revision;
  
  // Function pointers
  HMAC_SHA256_NEW         HmacSha256New;
  HMAC_SHA256_FREE        HmacSha256Free;
  // ... more functions
} ONE_CRYPTO_PROTOCOL;
```

### 2. Library Headers

Located in: `OneCryptoPkg/Include/Library/`

Generated files by group:
- `TlsLib.h` - TLS-related crypto functions
- `HmacLib.h` - HMAC-related crypto functions
- `OneCryptoLib.h` - All other crypto functions (default group)

Each header provides the same function signatures as the input, but implemented as library functions that call through the protocol.

### 3. Library Implementation

Located in: `OneCryptoPkg/Library/BaseCryptLibOnProtocolPpi/`

Generated file:
- `OneCryptoLib.c` - Implementation that calls crypto functions through the protocol

The implementation uses macros:
- `CALL_CRYPTO_SERVICE` - For functions with return values
- `CALL_VOID_CRYPTO_SERVICE` - For void functions

## Function Groups

Functions are organized into groups based on their `@ingroup` tag:

| Group | Description | Output Header |
|-------|-------------|---------------|
| `Tls` | TLS/SSL functions | `TlsLib.h` |
| `Hmac` | HMAC functions | `HmacLib.h` |
| `OneCrypto` | Default group for all other functions | `OneCryptoLib.h` |

Any function without an `@ingroup` tag is placed in the default `OneCrypto` group.

## Templates

The script uses template files located in `Templates/`:
- `OneCryptoLib.template.c` - Template for generating library implementation

Templates use a special replacement tag:
```c
// __REPLACEMENT_TAG__ - Autogenerated contents go here.
```

Generated code is inserted at this location.

## Configuration

### Paths (defined in script)

```python
SCRIPT_DIR = os.path.dirname(os.path.abspath(__file__))
INCLUDE_PATH = os.path.join(SCRIPT_DIR, "../../Include")
LIBRARY_INCLUDE_PATH = os.path.join(INCLUDE_PATH, "Library")
PROTOCOL_INCLUDE_PATH = os.path.join(INCLUDE_PATH, "Protocol")
LIBRARY_PATH = os.path.join(SCRIPT_DIR, "../../Library")
TEMPLATES_PATH = os.path.join(SCRIPT_DIR, "Templates")
```

### Customization

To add new function groups, modify:

```python
LIBRARY_GROUPS = [
    "Tls",
    "Hmac",
    # Add new groups here
]
```

## Workflow

1. **Parse Input** - Extract functions, comments, and metadata from header file
2. **Create Typedefs** - Generate function pointer typedefs
3. **Extract Version** - Parse VERSION_MAJOR/MINOR/REVISION macros
4. **Generate Protocol** - Create protocol structure with all function pointers
5. **Generate Libraries** - Create grouped library headers and implementations

## Error Handling

The script will raise errors if:
- Input header file not found
- Version macros not defined correctly
- Required function annotations missing (@since, @ingroup)
- Template files not found

## Dependencies

### Python Modules

- `argparse` - Command-line argument parsing
- `re` - Regular expression matching
- `io` - File I/O operations
- `json` - JSON handling (currently unused)
- `os` - Operating system interfaces
- `datetime` - Timestamp generation
- `logging` - Logging framework
- `collections.OrderedDict` - Ordered dictionary for function storage
- `dataclasses` - Data class definitions

### Optional

- `coloredlogs` - Enhanced colored logging (if installed)

## Logging

The script provides detailed logging:

```bash
# Default: INFO level
python CreateCryptoProtocol.py OpensslPkg/Include/Private/OneCryptoLibrary.h -p -l

# Debug: Detailed state machine and parsing information
python CreateCryptoProtocol.py OpensslPkg/Include/Private/OneCryptoLibrary.h -p -l -d
```

Log output includes:
- Number of functions found
- Files being generated
- Template processing status
- Path information for outputs

## Integration with Build System

After running the script, the generated files should be:

1. **Protocol Header** - Referenced by drivers that publish the crypto protocol
2. **Library Headers** - Included by modules that need crypto functionality
3. **Library Implementation** - Compiled as part of `BaseCryptLibOnProtocolPpi`

## Example Complete Workflow

```bash
# 1. Navigate to repository root
cd c:\git\flickdm\mu_crypto_release

# 2. Generate all files from the crypto library header
python OneCryptoPkg/OneCryptoBin/Scripts/CreateCryptoProtocol.py \
    OpensslPkg/Include/Private/OneCryptoLibrary.h -p -l

# 3. Verify generated files
ls OneCryptoPkg/Include/Protocol/OneCryptoProtocol.h
ls OneCryptoPkg/Include/Library/TlsLib.h
ls OneCryptoPkg/Include/Library/HmacLib.h
ls OneCryptoPkg/Include/Library/OneCryptoLib.h
ls OneCryptoPkg/Library/BaseCryptLibOnProtocolPpi/OneCryptoLib.c

# 4. Build the package
python SingleFlavorBuild.py OneCryptoPkg
```

## Maintenance

### Updating Crypto Functions

When adding new crypto functions:

1. Add function declaration with proper annotations to `OneCryptoLibrary.h`
2. Re-run the script to regenerate protocol and library files
3. Rebuild affected modules

### Version Updates

Update version macros in the input header file:

```c
#define VERSION_MAJOR     2ULL  // Breaking changes
#define VERSION_MINOR     1ULL  // New features
#define VERSION_REVISION  0ULL  // Bug fixes
```

## Troubleshooting

### "Failed to parse version"
- Ensure VERSION_MAJOR, VERSION_MINOR, and VERSION_REVISION are defined
- Check that values are in format `NULL` (e.g., `1ULL`)

### "Template file not found"
- Verify Templates directory exists
- Check that OneCryptoLib.template.c is present

### "No functions found"
- Verify input header contains properly formatted functions
- Check that @since and @ingroup tags are present
- Enable debug mode with `-d` to see parsing details

## License

Copyright (c) Microsoft Corporation.
SPDX-License-Identifier: BSD-2-Clause-Patent
